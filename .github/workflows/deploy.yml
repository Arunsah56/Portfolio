name: Deploy to Production

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - 'CONTRIBUTING.md'
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check deployment configuration
      run: |
        if [ -z "${{ secrets.DEPLOY_HOST }}" ]; then
          echo "⚠️  Deploy secrets not configured"
          echo "To enable deployment, add to GitHub Secrets:"
          echo "  - DEPLOY_HOST"
          echo "  - DEPLOY_USER"
          echo "  - DEPLOY_KEY"
          echo "  - DEPLOY_PATH"
          exit 0
        fi
        echo "✓ Deploy secrets found"

    - name: Deploy to server
      if: secrets.DEPLOY_HOST != null
      env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        mkdir -p ~/.ssh
        echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST \
          "cd $DEPLOY_PATH && git pull origin main && pip install -r requirements.txt && python manage.py migrate && python manage.py collectstatic --noinput && sudo systemctl restart gunicorn" || echo "Deployment skipped"
      continue-on-error: true

    - name: Success
      run: echo "✓ Workflow completed"

